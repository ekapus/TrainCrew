<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Initial Airbrake Test</title>


  <meta property="og:title" content="TrainCrew Webapp: Initial Airbrake Test" />
  <meta property="og:description" content="Simulate performing an initial airbrake test." />
  <meta property="og:type" content="website" />

  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/site.css" rel="stylesheet">


  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>
  <!-- Fixed navbar -->
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false"
          aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        <a class="navbar-brand" href="/index.html">TrainCrew</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/index.html">Home</a></li>
          <li><a href="switching.html">Switching</a></li>
          <li><a href="handbrakes.html">Handbrakes</a></li>
          <li class="active"><a href="airbrakes.html">Airbrakes</a></li>
          <li><a href="locomotive.html">Locomotives</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a href="about.html">About</a></li>
        </ul>

      </div>
      <!--/.nav-collapse -->
    </div>
  </nav>

  <div class="container body-container">

    <!-- Main component for a primary marketing message or call to action -->
    <h1>Initial Airbrake Test</h1>
    <div class="well">
      <p>To be performed when any crew takes control of a new train or if the trainline has been significantly modified.</p>
    </div>

    <ul class="list-group">

<!-- Step 1: -->

      <li class="list-group-item step step-1 ">
        <p>Step 1: Fully Charge the trainline. <span class="fast-clock-12"></span> seconds (fast clock) per car.</p>
        <label for="car-count">Train Length</label>
        <div class="input-group input-group-lg col-xs-7">
          <input name="car-count" type="number" id="car-count" class="form-control car-count"
            placeholder="number" aria-describedby="number-of-cars">
          <span class="input-group-addon" id="number-of-cars">cars</span>
        </div>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-charge step-1-button">Charge Train Line</button>
        <div class="progress airbrake-initial-test-charge-progress step-1-progress hidden">
          <div class="progress-bar airbrake-initial-test-charge-progress-bar step-1-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="100" style="min-width: 5em;">
            0 PSI
          </div>
        </div>
      </li>


<!-- /Step 1 -->

<!-- Step 2 -->
      <li class="list-group-item step step-2">
        <p>Step 2: Set brakes and hold pressure for <span class="fast-clock-60"></span> seconds (fast clock).</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-set step-2-button">Set Brakes</button>
        <div class="progress airbrake-initial-test-set-progress step-2-progress hidden">
          <div class="progress-bar airbrake-initial-test-set-progress-bar step-2-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
            style="min-width: 2em;">
            0 
          </div>
        </div>
      </li>
      <li class="list-group-item step step-2-fail">
        <p>Cannot hold air. Walk the train and inspect for defective car.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-set-inspect step-2-fail-button">Inspect</button>
        <div class="progress airbrake-initial-test-set-inspect-progress step-2-fail-progress hidden">
          <div class="progress-bar airbrake-initial-test-set-inspect-progress-bar step-2-fail-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="100" style="min-width: 5em;">
            0 Cars
          </div>
        </div>
      </li>
      <li class="list-group-item step step-2-resolve">
        <p>Set car out and begin test again.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-set-resolve step-2-resolve-button restart-button">Restart Test</button>
      </li>

<!-- /Step 2 -->


<!-- Step 3 -->
      <li class="list-group-item step step-3">
        <p>Step 3: Confirm pressure at the end of the trainline.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-confirm step-3-button">Confirm Pressure</button>
        <div class="alert airbrake-initial-test-confirm-badge"></div>
      </li>
      <li class="list-group-item step step-3-fail">
        <p>Air line pressure drop too great. Walk the train and inspect for defective car.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-confirm-inspect step-3-fail-button">Inspect</button>
        <div class="progress airbrake-initial-test-confirm-inspect-progress step-3-fail-progress hidden">
          <div class="progress-bar airbrake-initial-test-confirm-inspect-progress-bar step-3-fail-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="100" style="min-width: 5em;">
            0 Cars
          </div>
        </div>
      </li>
      <li class="list-group-item step step-3-resolve">
        <p>Set car out and begin test again.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-confirm-resolve step-3-resolve-button restart-button">Restart Test</button>
      </li>
<!-- /Step 3 -->



<!-- Step 4 -->
      <li class="list-group-item step step-4">
        <p>Step 4: Visually inspect all brakes for application.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-inspect step-4-button">Inspect</button>
        <div class="progress airbrake-initial-test-inspect-progress step-4-progress hidden">
          <div class="progress-bar airbrake-initial-test-inspect-progress-bar step-4-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="100" style="min-width: 5em;">
            0 Cars
          </div>
        </div>
      </li>
      <li class="list-group-item step step-4-resolve">
        <p>Set car out and begin test again.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-confirm-resolve step-4-resolve-button restart-button">Restart Test</button>
      </li>
<!-- /Step 4 -->



<!-- Step 5 -->
      <li class="list-group-item step step-5">
        <p>Step 5: Release brakes.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-release step-5-button">Release</button>
        <div class="alert airbrake-initial-test-release-badge step-5-badge"></div>
      </li>
<!-- /Step 5 -->


<!-- Step 6 -->
      <li class="list-group-item step step-6">
        <p>Step 6: Visually inspect all brakes for release.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-inspect-release step-6-button">Inspect</button>
        <div class="progress airbrake-initial-test-inspect-release-progress step-6-progress hidden">
          <div class="progress-bar airbrake-initial-test-inspect-release-progress-bar step-6-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
            aria-valuemax="100" style="min-width: 5em;">
            0 Cars
          </div>
        </div>
      </li>
      <li class="list-group-item step step-6-resolve">
        <p>Set car out and begin test again.</p>
        <button type="button" class="btn btn-lg btn-default airbrake-initial-test-confirm-resolve step-6-resolve-button restart-button" >Restart Test</button>
      </li>
<!-- /Step 6 -->


<!-- Step 7 -->
      <li class="list-group-item step step-7">
        <div class="alert airbrake-initial-test-success-badge"></div>
      </li>
<!-- /Step 7 -->      

    </ul>
    <hr />
    <ul class="nav nav-pills">
      <li class="nav-item">
        <a class="nav-link" href="airbrakes.html">Back to Airbrakes</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/index.html">Home</a>
      </li>


  </div>
  <!-- /container -->

  
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/site.js"></script>

  <script>

    // Useful video for details of brake test: https://www.youtube.com/watch?v=3lSOh-ES-o8
$(document).ready(function () {
    $(".step").hide();
    $(".step-1").show();

    var pressureModifier = 0;
    
    $(".airbrake-initial-test-confirm-badge").hide();
    $(".step-5-badge").hide();

    disable($(".airbrake-initial-test-charge"));

    $(".restart-button").click(function () {
      window.location.reload();
    });

    $(".car-count").on("change keyup paste", function () {
        var val = $("#car-count").val();
        if (!isNaN(val)) {
            enable($(".airbrake-initial-test-charge"));
        } else {
            disable($(".airbrake-initial-test-charge"));
        }

    });

    var maxBrakePipePressure = 90; // Potential air pressure range
    var brakePipePressure = maxBrakePipePressure;

  // -------------------
  // Step 1: Pump up the air to 90PSI
  
    $(".step-1-button").click(function () {

        disable($("#car-count"));

        var carCount = $("#car-count").val();
        var totalCars = parseInt(carCount, 10);
        var secondsPerCar = 12 * FAST_CLOCK_FACTOR;
        var totalSeconds = totalCars * secondsPerCar;

        percentPerSecond = 100 / totalSeconds;

        $(".airbrake-initial-test-charge-progress").show();
        $(".airbrake-initial-test-charge-progress").removeClass("hidden");

        var compressorRunAudio = new Audio("sounds/compressor-run.mp3");
        compressorRunAudio.loop = true;
        compressorRunAudio.play();

        console.log("-------------------")
        console.log("Step 1: Pump up the air to 90PSI")


        var secondsElapsed = 0;
        var progressBar = $('.step-1-progress-bar')
        var countDown = new Countdown({
            seconds: parseInt(totalSeconds),  // number of seconds to count down
            onUpdateStatus: function (sec) {
                var percentComplete = secondsElapsed * (percentPerSecond);
                secondsElapsed++;
                progressBar.css('width', percentComplete + '%').attr('aria-valuenow', percentComplete);
                progressBar.text(Math.round(percentComplete * (maxBrakePipePressure / 100)) + " PSI");
            }, // callback for each second
            onCounterEnd: function () {
                
                progressBar.css('width', '100% Complete').attr('aria-valuenow', 100);
                progressBar.text(maxBrakePipePressure + " PSI");
                progressBar.addClass("progress-bar-success");
                $(".step-2").show();
                PlaySound("sounds/compressor-end.mp3");
                compressorRunAudio.pause();
                
            } // final action
        });
        countDown.start();

        $(".airbrake-initial-test-charge").hide();

        console.log("Step 1: Complete")
    });

  // -------------------
  // Step 2: Set brakes and hold pressure for 1 minute (15s)

    $(".step-2-button").click(function () {

        $(".step-2-button").hide();

        // Determine test time length
        // 1 minute @ fast clock time
        var totalSeconds = 60 * FAST_CLOCK_FACTOR;
        // totalSeconds = 1; // Go quick, for testing;

        // Determine the likelihood of a failure
        var failureChance = generateRandomNumber(0, MAX_AIRBRAKE_FAILURE_RATE); // decimal (.0 - 1.0) chance pressure will be too low
        // failureChance = .1; // Train will not hold air, this is not a likely condition
        // failureChance = 0; // Never fail, for testing
        // failureChance = 1; // Always fail, for testing
        console.log("-------------------")
        console.log("Step 2: Set and hold for 1 minute")

        // Create the failure
        pressureModifier = 0;
        if(decideFailure(failureChance)){
          pressureModifier = Math.round(generateRandomNumber(0, 40));
          console.log("Step 2: Failure decided, failureChance=" + failureChance + " pressureModifier="+ pressureModifier);
        } else{
          console.log("Step 2: No failure decided, failureChance=" + failureChance + " pressureModifier="+ pressureModifier);
        }
        
        // Calculate pressure at end of test time (including drop that caused the failure)
        var naturalBrakePipeDrop = Math.round(generateRandomNumber(0, 2)); 
        var brakeApplicationDrop = 20;
        brakePipePressure = maxBrakePipePressure - naturalBrakePipeDrop - brakeApplicationDrop;
        var finalBrakePipePressure = brakePipePressure - pressureModifier;
        var safeBrakePipePressure = brakePipePressure-5;
        percentPerSecond = 100 / totalSeconds;

        console.log("Step 2: maxBrakePipePressure=" + maxBrakePipePressure);
        console.log("Step 2: brakeApplicationDrop=" + brakeApplicationDrop);
        console.log("Step 2: naturalBrakePipeDrop=" + naturalBrakePipeDrop);
        console.log("Step 2: pressureModifier=" + pressureModifier);
        console.log("Step 2: finalBrakePipePressure=" + finalBrakePipePressure);
        console.log("Step 2: safeBrakePipePressure=" + safeBrakePipePressure);

        console.log("Step 2: playing sound");
        // Show the progress of the test
        $(".step-2-progress").show();
        $(".step-2-progress").removeClass("hidden");
        PlaySound("sounds/air-purge-4.mp3");

        // Run the test
        var secondsElapsed = 0;
        var progressBar = $('.step-2-progress-bar');
        var countDown = new Countdown({
            seconds: parseInt(totalSeconds),  // number of seconds to count down
            onUpdateStatus: function (sec) {
                var percentComplete = secondsElapsed * (percentPerSecond);
                secondsElapsed++;
                progressBar.css('width', percentComplete + '%').attr('aria-valuenow', percentComplete);
                progressBar.text(secondsElapsed);
            }, // callback for each second
            onCounterEnd: function () {
                progressBar.css('width', '100% Complete').attr('aria-valuenow', 100);
                // Determine if the test failed
                if(finalBrakePipePressure >= safeBrakePipePressure){
                  // Final brake pipe Pressure is OK
                  progressBar.text(finalBrakePipePressure + " PSI");
                  progressBar.addClass("progress-bar-success");
                  $(".step-3").show();
                  console.log("Step 2: Pass, brakePipePressure="+ finalBrakePipePressure);
                } else {
                  // Final brake pipe Pressure is too low
                  progressBar.addClass("progress-bar-danger");
                  progressBar.text(finalBrakePipePressure + " PSI - TOO LOW");
                  $(".step-2-fail").show();
                  console.log("Step 2: Fail, finalBrakePipePressure="+ finalBrakePipePressure);
                }
            }
        });
        countDown.start();

        // Hide the initial test button
        $(".airbrake-initial-test-charge").hide();
        
        console.log("Step 2: Complete")
    });

    $(".step-2-fail-button").click(function () {

        console.log("Step 2 Failure State: Could Not Hold Air");

        $(".airbrake-initial-test-inspect").hide();
        $(".step-2-fail-button").hide();
        
        var carCount = $("#car-count").val();
        var totalCars = parseInt(carCount, 10);
        var secondsPerCar = 30 * FAST_CLOCK_FACTOR;
        var totalSeconds = totalCars * secondsPerCar;

        carsPerSecond = carCount / totalSeconds;
        percentPerSecond = 100 / totalSeconds;

        $(".airbrake-initial-test-set-inspect-progress").show();
        $(".airbrake-initial-test-set-inspect-progress").removeClass("hidden");

        carSuffix = "";

        // Which car is leaking?
        var defectCar = Math.round(generateRandomNumber(1, carCount));
        console.log("Step 2 Failure State: defectCar=" + defectCar);

        var carsInspected = 0;
        var secondsElapsed = 0;
        var progressBar = $('.step-2-fail-progress-bar');
        var failureCauses = [
                    'Damaged air hose',
                    'Leaking brake pipe',
                    'Leaking brake cylinder',
                    'Leaking reservoir',
                    'Unidentified air leak'
                  ];
        var defectCode = Math.floor(Math.random()*failureCauses.length);
        var defectType = failureCauses[defectCode];
        console.log("Step 2 Failure State: defectCode=" + defectCode);
        console.log("Step 2 Failure State: defectType=" + defectType);

        var countDown = new Countdown({
            seconds: parseInt(totalSeconds),  // number of seconds to count down
            onUpdateStatus: function (sec) {
                secondsElapsed++;
                
                var percentComplete = secondsElapsed * percentPerSecond;
                if(defectCar == Math.floor(carsInspected)){ 
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text(defectType + " on car " + defectCar + ". Set car out.");
                  progressBar.addClass("progress-bar-warning");
                  $(".step-2-resolve").show();
                  $(".airbrake-initial-test-set-inspect").hide();
                } else {
                  progressBar.css('width', percentComplete + '%').attr('aria-valuenow', percentComplete);
                  var carsInspectedText = Math.floor(carsInspected);
                  if (carsInspectedText == 1) {
                    carSuffix = "";
                  } else {
                    carSuffix = "s";
                  }
                  progressBar.text(carsInspectedText + " Car" + carSuffix);
                  carsInspected = carsInspected + .25;
              }
            }, // callback for each second
            onCounterEnd: function () {
                if(defectCar == Math.floor(carsInspected)){ 
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text(defectType + " on car " + defectCar + ". Set car out.");
                  progressBar.addClass("progress-bar-warning");
                  $(".step-2-resolve").show();
                  $(".airbrake-initial-test-set-inspect").hide();

                } else {
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text(carCount + " Car" + carSuffix);
                  progressBar.addClass("progress-bar-success");
                  $(".step-3").show();
                }
            } // final action
        });
        countDown.start();

        console.log("Step 2 Failure State: Complete");
    });



    $(".step-3-button").click(function () {

        // Air pressure at rear must be within 5lbs of the head end after 60 seconds.
        console.log("-------------------")
        console.log("Step 3: Air pressure at rear must be within 5lbs of the head end after 60 seconds.")

        $(".step-3-button").hide();
        

        var failureChance = generateRandomNumber(0, MAX_AIRBRAKE_FAILURE_RATE); // decimal (.0 - 1.0) chance pressure will be too low
        // failureChance = .1; // Train will not hold air, this is a slightly more likely condition
        // failureChance = 0; // Never fail, for testing
        // failureChance = 1; // Always fail, for testing
        
        pressureModifier = 0;
        if(decideFailure(failureChance)){
          pressureModifier = Math.round(generateRandomNumber(5, 40));
          console.log("Step 3: Failure decided");
          console.log("Step 3: failureChance="+ failureChance);
          console.log("Step 3: pressureModifier= "+ pressureModifier);
        }

        maxBrakePipePressure = brakePipePressure;
        brakePipePressure = brakePipePressure - Math.round(generateRandomNumber(1, 4));
        brakePipePressure = brakePipePressure - pressureModifier;

        if(brakePipePressure >= (maxBrakePipePressure-5)){
          // Good news! We held air.
          $(".airbrake-initial-test-confirm-badge").addClass("alert-success");
          $(".airbrake-initial-test-confirm-badge").text(brakePipePressure + " PSI");
          $(".airbrake-initial-test-confirm-badge").show();
          $(".step-4").show();
      } else {
          // Bad News: we couldn't hold air. Time to walk the train.
          $(".airbrake-initial-test-confirm-badge").addClass("alert-danger");
          $(".airbrake-initial-test-confirm-badge").text(brakePipePressure + " PSI - TOO LOW" );
          $(".airbrake-initial-test-confirm-badge").show();
          $(".step-3-fail").show();
      }
        
      console.log("Step 3: Complete");
    });

    $(".step-3-fail-button").click(function () {

        console.log("Step 3 Failure State: Too much of a pressure drop");

        $(".step-3-fail-button").hide();
        
        var carCount = $("#car-count").val();
        var totalCars = parseInt(carCount, 10);
        var secondsPerCar = 30 * FAST_CLOCK_FACTOR;
        var totalSeconds = totalCars * secondsPerCar;

        carsPerSecond = carCount / totalSeconds;
        percentPerSecond = 100 / totalSeconds;

        $(".step-3-fail-progress").show();
        $(".step-3-fail-progress").removeClass("hidden");

        carSuffix = "";

        // Which car is leaking?
        var defectCar = Math.round(generateRandomNumber(1, carCount));
        console.log("Step 3 Failure State: defectCar=" + defectCar);

        var carsInspected = 0;
        var secondsElapsed = 0;
        var progressBar = $('.step-3-fail-progress-bar');
        var failureCauses = [
                    'Damaged air hose',
                    'Leaking brake pipe',
                    'Leaking brake cylinder',
                    'Leaking reservoir',
                    'Unidentified air leak'
                  ];
        var defectCode = Math.floor(Math.random()*failureCauses.length);
        var defectType = failureCauses[defectCode];
        console.log("Step 3 Failure State: defectCode=" + defectCode);
        console.log("Step 3 Failure State: defectType=" + defectType);

        var countDown = new Countdown({
            seconds: parseInt(totalSeconds),  // number of seconds to count down
            onUpdateStatus: function (sec) {
                secondsElapsed++;
                
                var percentComplete = secondsElapsed * percentPerSecond;
                if(defectCar == Math.floor(carsInspected)){ 
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text(defectType + " on car " + defectCar + ". Set car out.");
                  progressBar.addClass("progress-bar-warning");
                  $(".step-3-resolve").show();
                  $(".airbrake-initial-test-set-inspect").hide();
                } else {
                  progressBar.css('width', percentComplete + '%').attr('aria-valuenow', percentComplete);
                  var carsInspectedText = Math.floor(carsInspected);
                  if (carsInspectedText == 1) {
                    carSuffix = "";
                  } else {
                    carSuffix = "s";
                  }
                  progressBar.text(carsInspectedText + " Car" + carSuffix);
                  carsInspected = carsInspected + .25;
              }
            }, // callback for each second
            onCounterEnd: function () {
                if(defectCar == Math.floor(carsInspected)){ 
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text(defectType + " on car " + defectCar + ". Set car out.");
                  progressBar.addClass("progress-bar-warning");
                  $(".step-3-resolve").show();
                  $(".airbrake-initial-test-set-inspect").hide();

                } else {
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text(carCount + " Car" + carSuffix);
                  progressBar.addClass("progress-bar-success");
                  $(".step-4").show();
                }
            } // final action
        });
        countDown.start();
        console.log("Step 3 Failure State: Complete");
    });

    $(".step-4-button").click(function () {

        console.log("-------------------");
        console.log("Step 4: Visually inspect all brakes for application.");


        $(".airbrake-initial-test-inspect").hide();
        
        var carCount = $("#car-count").val();
        var totalCars = parseInt(carCount, 10);
        var secondsPerCar = 15 * FAST_CLOCK_FACTOR;
        var totalSeconds = totalCars * secondsPerCar;

        carsPerSecond = carCount / totalSeconds;
        percentPerSecond = 100 / totalSeconds;

        $(".step-4-progress").show();
        $(".step-4-progress").removeClass("hidden");

        carSuffix = "";

        // Lets see if a car failed to apply
        var failureChance = generateRandomNumber(0, MAX_AIRBRAKE_FAILURE_RATE); // decimal (.0 - 1.0) chance a car has a kicker
        // failureChance = .1; // There is a car with brakes that won't apply
        // failureChance = 0; // Never fail, for testing
        // failureChance = 1; // Always fail, for testing
         
         var defectCar = 0;
         if(decideFailure(failureChance)){
          defectCar = Math.round(generateRandomNumber(1, carCount));
          console.log("Step 4: Failure decided");
          console.log("Step 4: failureChance="+ failureChance);
          console.log("Step 4: defectCar= "+ defectCar);
        } else {
          console.log("Step 4: Should pass");
          console.log("Step 4: failureChance="+ failureChance);
          console.log("Step 4: defectCar= "+ defectCar);
        }

        var carsInspected = 0;
        var secondsElapsed = 0;
        var progressBar = $('.step-4-progress-bar')
        var countDown = new Countdown({
            seconds: parseInt(totalSeconds),  // number of seconds to count down
            onUpdateStatus: function (sec) {
                secondsElapsed++;
                
                var percentComplete = secondsElapsed * percentPerSecond;
                if(defectCar == (carsInspected + 1)){ 
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text("Brakes not applied on car " + defectCar + ". Set car out.");
                  progressBar.addClass("progress-bar-danger");
                  $(".step-4-resolve").show();
                } else {
                  progressBar.css('width', percentComplete + '%').attr('aria-valuenow', percentComplete);
                  var carsInspectedText = Math.floor(carsInspected);
                  if (carsInspectedText == 1) {
                    carSuffix = "";
                  } else {
                    carSuffix = "s";
                  }
                  progressBar.text(carsInspectedText + " Car" + carSuffix);
                  carsInspected = carsInspected + .25;
              }
            }, // callback for each second
            onCounterEnd: function () {
              if(defectCar == (carsInspected + 1)){ 
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text("Brakes not applied on car " + defectCar + ". Set car out.");
                  progressBar.addClass("progress-bar-danger");
                  $(".step-4-resolve").show();
                } else {
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text("Completed");
                  progressBar.addClass("progress-bar-success");
                  $(".step-5").show();
                }
            } // final action
        });
        countDown.start();
        console.log("Step 4: Complete");
    });
    
    

    $(".step-5-button").click(function () {
        console.log("-------------------");
        console.log("Step 5: Release brakes");

        $(".airbrake-initial-test-release").hide();
        PlaySound("sounds/bleedoff.mp3");
        $(".step-5-badge").addClass("alert-success");
        $(".step-5-badge").text("Brakes Released");
        $(".step-5-badge").show();
        $(".step-6").show();
        $(".airbrake-initial-test-charge-progress").hide();
        console.log("Step 5: Complete");
    });

    $(".step-6-button").click(function () {

        console.log("-------------------");
        console.log("Step 6: Inspect brake release");

        $(".step-6-button").hide();

        var carCount = $("#car-count").val();
        var totalCars = parseInt(carCount, 10);
        var secondsPerCar = 15 * FAST_CLOCK_FACTOR;
        var totalSeconds = totalCars * secondsPerCar;

        carsPerSecond = carCount / totalSeconds;
        percentPerSecond = 100 / totalSeconds;

        $(".step-6-progress").show();
        $(".step-6-progress").removeClass("hidden");

        carSuffix = "";

        // Lets see if a car failed to release
        var failureChance = generateRandomNumber(0, MAX_AIRBRAKE_FAILURE_RATE); // decimal (.0 - 1.0) chance a car has a kicker
        // failureChance = .1; // There is a car with brakes that won't release
        // failureChance = 0; // Never fail, for testing
        // failureChance = 1; // Always fail, for testing
         
         var defectCar = 0;
         if(decideFailure(failureChance)){
          defectCar = Math.round(generateRandomNumber(1, carCount));
          console.log("Step 6: Failure decided");
          console.log("Step 6: failureChance="+ failureChance);
          console.log("Step 6: defectCar= "+ defectCar);
        } else {
          console.log("Step 6: Should pass");
          console.log("Step 6: failureChance="+ failureChance);
          console.log("Step 6: defectCar= "+ defectCar);
        }

        var carsInspected = 0;
        var secondsElapsed = 0;
        var progressBar = $('.step-6-progress-bar');
        var countDown = new Countdown({
            seconds: parseInt(totalSeconds),  // number of seconds to count down
            onUpdateStatus: function (sec) {
                secondsElapsed++;
                var percentComplete = secondsElapsed * percentPerSecond;
                progressBar.css('width', percentComplete + '%').attr('aria-valuenow', percentComplete);
                if(defectCar == (carsInspected+1)){ 
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text("Sticking brakes found on car " + defectCar + ". Set car out.");
                  progressBar.addClass("progress-bar-danger");
                  $(".step-6-resolve").show();
                } else{
                  var carsInspectedText = Math.floor(carsInspected);
                  if (carsInspectedText == 1) {
                    carSuffix = "";
                  } else {
                    carSuffix = "s";
                  }
                  progressBar.text(carsInspectedText + " Car" + carSuffix);
                  carsInspected = carsInspected + .25;
              }
            }, // callback for each second
            onCounterEnd: function () {

              if(defectCar == (carsInspected + 1)){ 
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text("Sticking brakes on car " + defectCar + ". Set car out.");
                  progressBar.addClass("progress-bar-danger");
                  $(".step-6-resolve").show();
                } else {
                  progressBar.css('width', '100%').attr('aria-valuenow', 100);
                  progressBar.text("Completed");
                  progressBar.addClass("progress-bar-success");
                  $(".step-7").show();
              
                $(".airbrake-initial-test-success-badge").addClass("alert-success");
                $(".airbrake-initial-test-success-badge").text("Test Successful");
                $(".airbrake-initial-test-success-badge").show();
              }
            } // final action
        });
        countDown.start();
        console.log("Step 6: Complete");
    });

});
</script>

</body>

</html>